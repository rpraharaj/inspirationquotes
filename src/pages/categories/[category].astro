---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import FormattedDate from '../../components/FormattedDate.astro';
import CategoryBadge from '../../components/ui/CategoryBadge.astro';
import TagPill from '../../components/ui/TagPill.astro';
import Icon from '../../components/ui/Icon.astro';
import { categories, getCategoryBySlug, type CategorySlug } from '../../config/categories';
import { siteConfig } from '../../config/site';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  
  return categories.map(category => ({
    params: { category: category.slug },
    props: { 
      category,
      posts: allPosts
        .filter(post => post.data.category === category.slug)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    },
  }));
}

const { category, posts } = Astro.props;

// Calculate reading time helper
function getReadingTime(content: string): string {
  const words = content.trim().split(/\s+/).length;
  const minutes = Math.ceil(words / 200);
  return minutes === 1 ? '1 min read' : `${minutes} min read`;
}
---

<BaseLayout 
  title={`${category.name} Articles: Guides, Tutorials & Code | AI Agents Kit`} 
  description={`Discover ${posts.length}+ ${category.name.toLowerCase()} articles. ${category.description} Find tutorials, code examples, and expert guides.`}
>
  <div class="py-16 sm:py-24">
    <div class="mx-auto max-w-wide px-4 sm:px-6">
      <!-- Header -->
      <header class="mb-12 animate-fade-in">
        <a 
          href="/categories" 
          class="inline-flex items-center gap-2 text-sm text-foreground-tertiary hover:text-foreground transition-colors mb-6"
        >
          <Icon name="arrow-left" size={16} />
          All Categories
        </a>
        
        <div class="flex items-center gap-4 mb-4">
          <div class="p-3 rounded-xl bg-background-secondary border border-border">
            <Icon name={category.icon} size={32} strokeWidth={1.5} />
          </div>
          <h1 class="text-3xl sm:text-4xl font-bold tracking-tight">{category.name}</h1>
        </div>
        <p class="text-lg text-foreground-secondary max-w-2xl">
          {category.description}
        </p>
        <p class="text-sm text-foreground-tertiary mt-2 flex items-center gap-2">
          <Icon name="file-code" size={14} />
          {posts.length} {posts.length === 1 ? 'article' : 'articles'}
        </p>
      </header>
      
      <!-- Posts Grid -->
      {posts.length > 0 ? (
        <div class="grid gap-10 sm:grid-cols-2 lg:gap-12">
          {posts.map((post, index) => (
            <article 
              class:list={[
                'group animate-slide-up',
                `stagger-${Math.min(index + 1, 4)}`,
                index === 0 && posts.length > 1 && 'sm:col-span-2'
              ]}
            >
              <a href={`/blog/${post.id}/`} class="block">
                <div class:list={[
                  'aspect-video overflow-hidden rounded-xl bg-background-secondary border border-border mb-4',
                  index === 0 && posts.length > 1 && 'lg:aspect-[21/9]'
                ]}>
                  {post.data.heroImage ? (
                    <img 
                      src={post.data.heroImage} 
                      alt={`Featured image for ${post.data.title}`}
                      width={index === 0 ? 960 : 480}
                      height={index === 0 ? 540 : 270}
                      class="w-full h-full object-cover transition-all duration-500 group-hover:scale-105"
                      loading={index < 3 ? 'eager' : 'lazy'}
                      decoding="async"
                    />
                  ) : (
                    <div class="w-full h-full flex items-center justify-center text-foreground-tertiary">
                      <Icon name="file-code" size={48} strokeWidth={1} />
                    </div>
                  )}
                </div>
                
                <div class:list={[index === 0 && posts.length > 1 && 'max-w-2xl']}>
                  <div class="flex items-center gap-3 text-sm text-foreground-tertiary mb-3">
                    <FormattedDate date={post.data.pubDate} />
                    {post.body && (
                      <>
                        <span>Â·</span>
                        <span class="inline-flex items-center gap-1">
                          <Icon name="clock" size={14} />
                          {getReadingTime(post.body)}
                        </span>
                      </>
                    )}
                  </div>
                  
                  <h2 class:list={[
                    'font-bold tracking-tight group-hover:text-foreground-secondary transition-colors line-clamp-2',
                    index === 0 && posts.length > 1 ? 'text-2xl sm:text-3xl' : 'text-xl'
                  ]}>
                    {post.data.title}
                  </h2>
                  
                  {post.data.description && (
                    <p class:list={[
                      'text-foreground-secondary mt-3 line-clamp-2',
                      index === 0 && posts.length > 1 ? 'text-base' : 'text-sm'
                    ]}>
                      {post.data.description}
                    </p>
                  )}
                  
                  {post.data.tags && post.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2 mt-4">
                      {post.data.tags.slice(0, 3).map((tag: string) => (
                        <TagPill tag={tag} />
                      ))}
                    </div>
                  )}
                </div>
              </a>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <div class="p-4 rounded-xl bg-background-secondary border border-border inline-block mb-4">
            <Icon name={category.icon} size={48} strokeWidth={1} class="text-foreground-tertiary" />
          </div>
          <h2 class="text-lg font-semibold mb-2">No articles yet</h2>
          <p class="text-foreground-secondary mb-6">
            We're working on content for this category. Check back soon!
          </p>
          <a 
            href="/blog" 
            class="inline-flex items-center gap-2 text-sm font-medium hover:text-foreground-secondary transition-colors"
          >
            Browse all articles
            <Icon name="arrow-right" size={16} />
          </a>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
